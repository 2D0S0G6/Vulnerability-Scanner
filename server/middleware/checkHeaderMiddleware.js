const { query } = require('../utils/dbUtils');

function checkHeader(headerName, expected = '', api = false) {
    return async (req, res, next) => {
        const headerValue = req.headers[headerName] || '';
        if (api) {
            const status = headerValue === expected ? 'Found' : 'Not equal';
            return res.send(status);
        }

        try {
            const sql = 'SELECT COUNT(*) AS count FROM apiKeys WHERE api_key = ?';
            const result = await query(sql, [headerValue]);
            const count = result[0].count;

            if (count > 0) {
                next();
            } else {
                res.status(403).json({ error: `Invalid value for header '${headerName}'` });
            }
        } catch (error) {
            console.error('Error checking header:', error);
            res.status(500).json({ error: 'Internal server error' });
        }
    };
}

module.exports = { checkHeader };