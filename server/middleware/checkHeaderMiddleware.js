const { query } = require('../utils/dbUtils');

// Check for a specific header
function checkHeader(headerName) {
    return async function(req, res, next) {
        if (req.headers[headerName]) {
            const headerValue = req.headers[headerName];
            try {
                const sql = 'SELECT COUNT(*) AS count FROM apiKeys WHERE api_key = ?';
                const result = await query(sql, [headerValue]);
                const count = result[0].count;
                if (count > 0) {
                    next();
                } else {
                    res.status(403).json({ error: `Invalid value for header '${headerName}'` });
                }
            } catch (error) {
                console.error('Error checking header:', error);
                res.status(500).json({ error: 'Internal server error' });
            }
        } else {
            res.status(400).json({ error: `Header '${headerName}' is missing` });
        }
    };
}

module.exports = {
    checkHeader
};