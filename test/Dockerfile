FROM ubuntu:20.04
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Seoul

# Update and install required packages
RUN apt-get update && \
    apt-get install -y mysql-server neovim net-tools apache2 php libapache2-mod-php php-mysql && \
    apt-get clean

# Set up MySQL
RUN mkdir -p /var/lib/mysql /var/run/mysqld && \
    chown -R mysql:mysql /var/lib/mysql /var/run/mysqld && \
    chmod 777 /var/run/mysqld

# Set up Apache
RUN a2enmod rewrite

# Create Apache error log directory and set permissions
RUN mkdir -p /var/log/httpd && \
    chown -R www-data:www-data /var/log/httpd

# Copy application files and configurations
COPY . /var/www/html
COPY config/mysql-init.sql /docker-entrypoint-initdb.d/mysql-init.sql
COPY config/apache-config.conf /etc/apache2/sites-available/000-default.conf

# Set Apache document root
RUN sed -ri -e 's!/var/www/html!/var/www/html!g' /etc/apache2/sites-available/*.conf

# Enable Apache default site
RUN a2ensite 000-default.conf

# Expose port 80
EXPOSE 80

# Start MySQL and Apache services using CMD
CMD ["sh", "-c", "service mysql start && echo 'Waiting 5 seconds for MySQL to boot...' && sleep 5s && mysql -h localhost -u root < /docker-entrypoint-initdb.d/mysql-init.sql && apache2ctl configtest && rm /var/www/html/index.html && apachectl -D FOREGROUND"]
