# Use Ubuntu as the base image
FROM ubuntu:latest

# package installation
RUN apt-get update && \
    apt-get install -y curl wget gnupg lsb-release && \
    apt-get clean
    
RUN wget https://dev.mysql.com/get/mysql-apt-config_0.8.15-1_all.deb

RUN dpkg -i mysql-apt-config_0.8.15-1_all.deb

RUN DEBIAN_FRONTEND="noninteractive" apt-get install -y mysql-server && \
    apt-get clean

RUN rm mysql-apt-config_0.8.15-1_all.deb

RUN mkdir -p /var/lib/mysql /var/run/mysqld && \
    chown -R mysql:mysql /var/lib/mysql /var/run/mysqld && \
    chmod 777 /var/run/mysqld

# Update package lists and install necessary packages
RUN apt-get update && \
    apt-get install -y apache2 php libapache2-mod-php php-mysql && \
    apt-get clean

# Enable Apache module rewrite
RUN a2enmod rewrite

# Copy PHP code to the container at /var/www/html
COPY . /var/www/html

# Copy MySQL initialization script
COPY config/mysql-init.sql /docker-entrypoint-initdb.d/mysql-init.sql

# Create the log directory for Apache
RUN mkdir -p /var/log/httpd

# Allow Apache to override configuration using .htaccess files
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf

# Update the default Apache site with the configuration we created
ADD config/apache-config.conf /etc/apache2/sites-available/000-default.conf

# Expose port 80
EXPOSE 80

# Start MySQL and Apache in the foreground
CMD service mysql start && service apache2 start && mysql -h localhost -u root < /docker-entrypoint-initdb.d/mysql-init.sql && \
    tail -f /var/log/apache2/*.log
